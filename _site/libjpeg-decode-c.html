<!DOCTYPE html>
<html>
<head>
    <!--
    * Author:         BeiYuu
    * Revised:        pkokp8
    -->
    <meta charset="utf-8" />
    <title>libjpeg不完全解 | pkokp8's blog</title>
    <meta name="author" content="pkokp8" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="Everything about pkokp8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
    <link rel="alternatecss" type="application/rss+xml" title="“pkokp8's Blog”" href="http://localhost:4000/feed.xml">
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>

    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">pkokp8</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="https://github.com/pkokp8/" target="_blank" style="margin-left:-5px;"><img src="https://github.com/favicon.ico" alt="" width="22"/></a>
            <a href="http://tieba.baidu.com/f?kw=firefox&fr=index&red_tag=x1116532383" target="_blank" style="text-align:center;"><img src="https://tb1.bdstatic.com/tb/favicon.ico" alt="" width="22"/></a>
            <a href="https://leetcode.com/pkokp8/" target="_blank" style="text-align:center;"><img src="https://leetcode.com/favicon-32x32.png" alt="" width="22"/></a>
            <!--
			<a href="/feed.xml" target="_blank" style="text-align:right"><img src="http://static.firefoxchina.cn/img/201711/7_5a0ba48885d170.png" alt="" width="22"/></a>
			-->
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#B9D3EE; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/libjpeg-decode-c" title="libjpeg不完全解">libjpeg不完全解</a></h1>
        <p class="entry-date">2018-03-05</p>
        <p>先放一张图。</p>

<p><img src="/images/libjpegmaterial/CactiIslaPescado_ZH-CN11317505000_1920x1080_orig.jpg" alt="avatar" /></p>

<p>jpeg有非常多格式，后面会拿上图作示例。这是一张jfif格式的jpeg图像。</p>

<p>这张图的格式是这样的：</p>

<pre>
SOI				(0xFFD8)
APP0			(0xFFE0)
DQT				(0xFFDB)
DQT				(0xFFDB)
SOF0			(0xFFC0)
DHT				(0xFFC4)
DHT				(0xFFC4)
DHT				(0xFFC4)
DHT				(0xFFC4)
SOS				(0xFFDA)
实际图像的压缩数据
EOI				(0xFFD9)
</pre>

<p>
然后放一段可以直接拿来用的libjpeg的sample代码。这段代码并没有经过仔细的优化，部分显示效果也并不是最佳。但作为解码的初解，应该够了吧。
</p>
<pre>
int jpeg_to_yuv422(unsigned char *jpeg_buffer,int insize, unsigned char **yuv_buffer, int *yuvlen)
{
	int a, i;
	int width, height;
	int r, g, b;
	int c,m,y,k;
	struct jpeg_decompress_struct cinfo;
	struct my_error_mgr jerr;
	JSAMPARRAY buffer;
	int row_stride;
	unsigned char *curptr = NULL;
	unsigned char *rgb24_buffer = NULL;

	cinfo.err = jpeg_std_error(&amp;jerr.pub);  
//  	jerr.pub.error_exit = my_error_exit;

	if(setjmp(jerr.setjmp_buffer))
	{
		printf("my err %d\n", insize);
		jpeg_destroy_decompress(&amp;cinfo);

		return 1;
	}

	jpeg_create_decompress(&amp;cinfo);
	jpeg_mem_src(&amp;cinfo, jpeg_buffer, insize);
	(void) jpeg_read_header(&amp;cinfo, TRUE);

	//cinfo.out_color_space = JCS_YCbCr;
	//cinfo.raw_data_out = TRUE;

	
	(void) jpeg_start_decompress(&amp;cinfo);

	int alignwidth = 0;
	if(cinfo.output_width % 16)
	alignwidth = cinfo.output_width / 16 * 16 + 16;
	else
	alignwidth = cinfo.output_width;

	row_stride = alignwidth * cinfo.output_components;
	width = alignwidth;
	height = cinfo.output_height;
	*yuvlen = width * height * 2;

	buffer = (*cinfo.mem-&gt;alloc_sarray) ((j_common_ptr) &amp;cinfo, JPOOL_IMAGE, row_stride, 1);

	rgb24_buffer = (unsigned char*)malloc(width * height * 3);
	memset(rgb24_buffer, 0, width * height * 3);
	printf("%d, color space %d\n", __LINE__, cinfo.out_color_space);

	if(cinfo.out_color_space == JCS_RGB)
	{
		curptr = rgb24_buffer;
		for(a = 0; a &lt; height; a++)
		{
			(void) jpeg_read_scanlines(&amp;cinfo, buffer, 1);

			for(i = 0; i &lt; row_stride; i += 3)
			{
				r = (int)buffer[0][i];
				g = (int)buffer[0][i + 1];
				b = (int)buffer[0][i + 2];

				*curptr++ = r;
				*curptr++ = g;
				*curptr++ = b;
			}

		}
	}
	else if(cinfo.out_color_space == JCS_GRAYSCALE)
	{
		curptr = rgb24_buffer;
		for(a = 0; a &lt; height; a++)
		{
			(void) jpeg_read_scanlines(&amp;cinfo, buffer, 1);

			for(i = 0; i &lt; row_stride; i += 1)
			{
				g = (int)buffer[0][i];

				*curptr++ = g;
				*curptr++ = g;
				*curptr++ = g;
			}

		}
	}
	else if(cinfo.out_color_space == JCS_CMYK)
	{
		curptr = rgb24_buffer;
		for(a = 0; a &lt; height; a++)
		{
			(void) jpeg_read_scanlines(&amp;cinfo, buffer, 1);

			for(i = 0; i &lt; row_stride; i += 4)
			{
				c = (int)buffer[0][i];
				m = (int)buffer[0][i + 1];
				y = (int)buffer[0][i + 2];
				k = (int)buffer[0][i + 3];

				
				r = (k*c)/255;
				g = (k*m)/255;
				b = (k*y)/255; 
				 
				*curptr++ = r;
				*curptr++ = g;
				*curptr++ = b;
			}

		}
	}
	else
	{
		printf("jpg_to_yuv:unsupported jpeg color space %d, aborting.\n",  cinfo.out_color_space);
		return -1;
	}
	//(*cinfo.mem-&gt;free_pool) ((j_common_ptr) &amp;cinfo, JPOOL_IMAGE);

	/* rbgb24 to yuv */
	{
		*yuv_buffer = (unsigned char*)malloc(width * height * 2);
		RGB2YUV422(rgb24_buffer, *yuv_buffer, height * width);
	}
	(void) jpeg_finish_decompress(&amp;cinfo);

	jpeg_destroy_decompress(&amp;cinfo);

	if(jerr.pub.num_warnings)
	{
		printf("jpg_to_yuv: jpeg lib warnings=%ld occurred\n", jerr.pub.num_warnings);
		return -1;
	}

	return 0;
}

</pre>

<p>然后开始讲解一下这段代码。</p>
<h1 id="jpeg_std_error">jpeg_std_error</h1>
<p>这是一个异常处理函数相关的注册。libjpeg所有的异常返回，默认都是直接调用exit退出。也就是说如果发生了错误，程序就直接挂了。这在本地测试、使用时没什么问题，出错了定位一下，然后接着用。但生产环境中动不动就可能程序退出，还没什么日志，这怎么行？libjpeg提供了一种方法，先覆盖默认的error_exit函数指针。<br />
例如提供一个my_error_exit函数通过jpeg_std_error注册进libjpeg。<br />
在my_error_exit以及解码接口中通过setjmp/longjmp实现函数间的跳转。具体可以看一下example.c的实现。不难</p>

<h1 id="jpeg_create_decompress">jpeg_create_decompress</h1>
<pre>
/* jpeglib.h */
#define jpeg_create_decompress(cinfo) \
    jpeg_CreateDecompress((cinfo), JPEG_LIB_VERSION, \
			  (size_t) sizeof(struct jpeg_decompress_struct))

</pre>
<p>可见，实际jpeg_create_decompress接口就是jpeg_CreateDecompress。函数实现在jdapimin.c中。记住，源码文件前缀的命名，j是jpeg，c是compress，d是decompress。<br />
实际上这个接口仅仅是向解码结构体j_decompress_ptr中注册一些函数指针，初始化一些数据结构，并且标记这个解码结构体的解码状态为DSTATE_START</p>
<pre>
#define DSTATE_START	200	/* after create_decompress */
</pre>


        <div id="disqus_container">
            <class="comment"/>
<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
	/*	//disqus is walled by the great fire wall XD
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//mukosame.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
	*/
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        
        </div>
   </div>
   
    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86-%E9%A2%9C%E8%89%B2%E6%B8%90%E5%8F%98-c">颜色渐变</a></li>
        
            <li><a href="/libjpeg-decode-c">libjpeg不完全解</a></li>
        
            <li><a href="/%E5%89%91%E6%8C%87offer-linux-c">剑指offer学习</a></li>
        
            <li><a href="/git-simple-use">git的简单操作</a></li>
        
            <li><a href="/python-copy-list">复制一个list</a></li>
        
        </ul>

        <h2>Dump</h2>
        <ul class="artical-list">
        
            <li><a href="/test1-test2-test3">pass</a></li>
        
        </ul>

        <h2>Project</h2>
        <ul class="artical-list">
        
            <li><a href="/test1-test2-test3">pass</a></li>
        
        </ul>
    </div>
</div>

<script src="/js/post.js" type="text/javascript"></script>



<!--
todo: some elements are covered by other.maybe it's because the follow of css or js?
<div id="container"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  id: 'location.href', // 可选。默认为 location.href  比如我本人的就删除了
  owner: 'pkokp8',              //比如我的叫anTtutu
  repo: 'pkokp8.github.io',                 //比如我的叫anTtutu.github.io
  oauth: {
    client_id: '0adcc87f3cacd0dc791e',          //比如我的828***********
    client_secret: '9a5bc6ea6b50a06ca18592308039acd982d72381',  //比如我的49e************************
  },
})
gitment.render('container')
</script>
-->

    <script type="text/javascript">
        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })
    </script>
</body>
</html>
